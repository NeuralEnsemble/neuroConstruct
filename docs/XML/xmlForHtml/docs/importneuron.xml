<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE document PUBLIC "-//APACHE//DTD Documentation V2.0//EN" "http://forrest.apache.org/dtd/document-v20.dtd">
<document>
  <header>
    <title>Importing existing NEURON/GENESIS models into neuroConstruct</title>
  </header>
  <body>


<p>Outlined here is the process for taking an existing cell model in NEURON (hoc and mod files) and reimplementing it in neuroConstruct (a very similar process is used for importing GENESIS models).
At the moment it can be a complicated process but the advantages of doing it are:</p>
<ul>
<li>It is easier to incorporate single cell models into networks of arbitrary size and complexity once they are in neuroConstruct</li>
<li>It simplifies making the model available for multiple simulators (e.g. <a href="Glossary_gen.html#GENESIS">GENESIS</a> too). Once in neuroConstruct/NeuroML format,
the cell model will be available for any other simulator supported by these in the future (e.g. GENESIS 3/MOOSE/Parallel NEURON), provided the cell mechanisms can be implemented in that simulator.</li>
<li>All of the inbuilt functionality for storing, browsing and analysing simulations neuroConstruct is available</li>
<li>A neuroConstruct <a href="Glossary_gen.html#Project">project</a> including the model description, results of the simulation, plots of the figures in
published papers, etc. can be distributed in a single zipped file</li>
<li>The model can be easily rerun and model parameters changed by those without knowledge of the native scripting environment</li>
</ul>
<p>Note: Exporting NeuroML from simulators will facilitate this process. NEURON 6.1 allows export of cell morphologies together with channel densities in NeuroML format from ModelView. See 
<a href="http://neuroml.svn.sourceforge.net/viewvc/neuroml/nrn2NeuroML">here</a> for the latest version.</p>




<section>
  <title>Bringing NEURON models into neuroConstruct</title>

<ol>
<li>With a fully tested NEURON model, ensure the hoc code is split between separate files containing a) the
morphologies of the cells, b) the mod files containing the cell mechanisms (including default values for all parameters,
e.g. max conductance densities) c) the main hoc file which creates the cells, places the channels on the cells, adds the
stimulations, etc. and runs the main simulation and d) a file which creates any GUI elements for plotting data,
(re)running the simulation and changing parameters. This is the standard way to split functionality between files (generally used for the models in 
<a href="http://senselab.med.yale.edu/modeldb">ModelDB</a>), and if
a model is published with everything in a single large file, there is little chance of reusing much in neuroConstruct.</li>

<li>In general neuroConstruct should be able to import files a) above and include b) as the NEURON implementation of <a href="Glossary_gen.html#Cell Mechanism">Cell Mechanisms</a>.
The simulation parameters in c) will be set through the neuroConstruct GUI by hand, and any plots of data can also be specified
through the interface.</li>

<li>Select <strong>File->New Project</strong>, and enter the name and location of your new project.</li>
<li>To import a NEURON *.hoc/*.nrn morphology
file Go to <strong>Cell Types -> Add New Cell Type</strong> and select <strong>NeuronMorphReader</strong> in the first drop down box.
Select the morphology file by entering the path into the text field or pressing the <strong>...</strong> button and
selecting the file manually. Note that the biggest problem in importing files is that there is no prescribed way to write
NEURON morphology files, unlike the *.p (readcell) file format in GENESIS. For the importation process, it assumes the
form of a file similar to that generated by NTS cable (usually a *.nrn file). This will normally contain only <strong>create</strong> statements,
<strong>pt3dadd</strong> commands, <strong>connect</strong> commands and the <strong>fscan</strong> function. Other commands
e.g. <strong>insert</strong> are ignored in this version. More details <a href="import.html#NEURON">here</a>. It wasn't
an easy matter creating an importer for general NEURON morphology files, so not every *.hoc/*.nrn file will work first time. If you
have specific problems, <a href="../contact/index.html">send me</a> the morphology file and I'll try to adjust the
importer to deal with it, or I can suggest ways to rewrite the file in a simpler format. Alternatively for cells with
a small number of sections (&lt;10), you can add a Simple Cell (via tab <strong>Cell Types -> Add New Cell to Project</strong>),
rename it, press <strong>View this cell in 3D</strong>, click on a section, press <strong>Edit...</strong> and add/delete
sections as appropriate, building your morphology as you go. </li>

<li>As an alternative to the above, the cell could be loaded into NEURON 6.1 (with the updated files from <a href="http://neuroml.svn.sourceforge.net/viewvc/neuroml/nrn2NeuroML">here</a>)
using the original hoc/mod files
and exported from ModelView (<strong>Tools -> ModelView -> File -> Export to NeuroML</strong>). This works best if there is just one cell loaded in NEURON. The function <strong>define_shape()</strong> should be run 
before export to ensure all NEURON sections have full 3D info. Level 1 exports will have just the cell morphology, Level 2 will include info on channel densities. The NeuroML file
exported can then be imported into neuroConstruct similar to the manner above, via <strong>Cell Types -> Add New Cell Type</strong> and selecting the <strong>NeuroMLConverter</strong> option.
If a Level 2 export is used, there should already be channel mechanisms in the neuroConstruct project with the same names as those in the NEURON model (see below).</li>



<li>To include a <a href="Glossary_gen.html#Channel Mechanism">Channel Mechanism</a> (e.g. a voltage dependent ion channel) or
a <a href="Glossary_gen.html#Synaptic Mechanism">Synaptic Mechanism</a> based on an existing mod file go to tab <strong>Cell Mechanisms</strong>,
select <strong>Create File Based Mechanism</strong>. Enter the name of the Cell Mechanism. If the mod file is a density mechanism,
choose "Channel Mechanism". If it represents the end point of a synaptic connection, choose "Synaptic Mechanism". Select the
*.mod file which implements the Channel Mechanism/Synapse when prompted. Existing Channel Mechanisms implemented in NMODL
can be reused with a few small changes. In the line specifying the the name of the mechanism in the original
NMODL file, replace the name string with %Name%, so for example in Exp3Syn.mod the line<br/>

&nbsp;&nbsp;POINT_PROCESS Exp3Syn<br/>

becomes<br/>

&nbsp;&nbsp;POINT_PROCESS %Name%<br/>

and in a channel mechanism NaFast.mod<br/>

&nbsp;&nbsp;SUFFIX NaFast<br/>

becomes<br/>

&nbsp;&nbsp;SUFFIX %Name%<br/>

In general any value between %'s will be replaced with another value by neuroConstruct. Another change which should
be made in your NMODL files is to replace the value of the max conductance density with %Max Conductance Density% in
channel mechanisms and the max conductance with %Max Conductance% in synapses. Note: the variable name <strong>gmax</strong> should be used for
the max conduction density in channels and max conductance in synapses, so that neuroConstruct will know the public variable
name so it can access it from the hoc. To get a better idea of what's going on,
open (via <strong>Edit selected Cell Mechanism</strong>) any of the File Based Cell Mechanisms included in examples/Ex8-DentateGyrus,
paying attention to the NEURON template code. More information is available <a  href="cellmechanism.html">here</a></li>

<li>To put the channel mechanisms on to the cell you have imported (if you haven't used a NeuroML import detailing channel placement), go to <strong>Visualisation</strong>, select the cell
name in the drop down box and press <strong>View</strong>. Select <strong>Groups</strong> in the bottom right drop down box.
There are some basic groups defined, but to add others, click <strong>Edit Groups</strong>. In this way
<a href="Glossary_gen.html#Section Group">Section Groups</a> (corresponding to SectionLists as used in NEURON)
which will have similar biophysical properties can be defined. Now select <strong>Cell density mechanisms</strong> in the drop down box,
and click <strong>Edit Density Mechanisms</strong>. You can now place the Channel Mechanisms on the groups you have created.
If it's a single compartment cell, just use the group all.</li>

<li>Finally create a new <a href="Glossary_gen.html#Region">Region</a>, create a new <a href="Glossary_gen.html#Cell Group">Cell Group</a>
(the default values will create a single randomly placed cell) and press <strong>Generate</strong>. You can also add an
electrophysiological input (e.g. an IClamp) and a graph of the cell voltage via the tab <strong>Input/Output</strong>.
Again the default values should be a good starting point.</li>

<li>Hopefully all of this will be successful and you can go to tab <strong>Export</strong> and generate the NEURON code. </li>

<li>This description only concerns placing one cell in 3D. Once each cell works as expected, networks can be built. See the
description of <a href="netconns.html">Network Connections</a> for more information.</li>
</ol>

</section>

<section>
  <title>Converting mod file/GENESIS script channels into ChannelML</title>


<ol>
<li>The goal of this is to create a ChannelML file with the same mechanism as one present in an existing mod file/GENESIS script. Look at the included example Ex10-MainenEtAl which contains a
<a href="Glossary_gen.html#Simulation Configuration">Simulation Configuration</a> SimpleCells which shows an example of this procedure.</li>
<li>Instead of trying to match the channels using the full cell morphology, start with a single section (ideally just one segment), e.g. the soma of the cell to be converted. 
You can use the imported morphology (e.g. Cell1), create a copy of it (Cell1_original) and delete all sections, just leaving the soma section.</li>
<li>Create a cell group with a single instance of the soma section (CG_original).</li>
<li>Get the passive properties working properly. Use psection() on the corresponding section in your original NEURON model to get values for cm, Ra etc. and 
update the values of these on your neuroConstruct version (use the LeakConductance built in ChannelML mechanism for the passive conductance, as in the examples). 
Add a small current pulse to the section and add a plot for the voltage. Generate the network and check the section's basic parameters using psection().</li>
<li>Make a copy of the cell (Cell1_CML) and a new cell group with that cell (CG_CML). Add a current pulse and a plot of the voltage and generate the 
network again to ensure the 2 plots overlap (the Graph Window property of the plot can be altered in neuroConstruct to get the 2 traces in the same window in NEURON).</li>


<li>Convert a simple channel first, e.g. non-Ca2+ dependent K channel. Use the original mod file for a <strong>File based Cell Mechanism</strong> as outlined above and <a  href="cellmechanism.html">here</a></li>
<li>Add this mechanism to Cell1_original (View cell in 3D, select <strong>Cell density mechanisms</strong> in drop down box, then <strong>Edit Density Mechanisms</strong>). 
Use the cell density on your original soma section. See menu item <strong>Help -> Units</strong> for units in neuroConstruct and NEURON, or (after placing the mechanism on the section)
select <strong>Pick Sections/Segments</strong> in the drop down box, click on the section, click on <strong>Biophysics</strong>, which will show a list of the biophsical quantities associated with the section.</li>

<li>Add a plot of the internal state variables of the channel, e.g. KChannel:n. See Ex4-NEURONGENESIS or Ex10-MainenEtAl for examples. Run the network again and you should see a difference between the cell with the active channel and
that with only a passive conductance.</li>

<li>Add an initial version of the channel as a <strong>ChannelML based Cell Mechanism</strong>. Select <strong>Add ChannelML from Template</strong>, selecting KConductance, and give the channel an appropriate name. Add a plot of its internal variable (see Ex10-MainenEtAl) and put this in the same graph as the prevous channel's.</li>


<li>Now edit the values in the XML to match the equations in the mod file (preferably in an external text editor). With a simple channel it should just be a case of altering the parameters for the linoid, sigmoid etc. descriptions of the rate equations, the reversal potential and the gate powers.
Don't forget to add lots of comments and metadata!
For more complicated channels, see the examples in Ex7-GranuleCell and <a href="http://www.morphml.org:8080/NeuroMLValidator/Samples.jsp">online</a>.</li>

<li>Make sure to reload the ChannelML into neuroConstruct after you've edited the XML externally. Add this channel to Cell1_CML and rerun the simulation with this new channel. Looking at the mod file generated from the XML will help in debugging.</li>

<li>Getting good agreement can depend on the accuracy k value in Akd, make sure there is an accurate value for this in case 1/k is used in the original file.</li>

<li>For complete accuracy, use table impl prefs taken from original mod file, i.e. from TABLE minf, mexp DEPEND dt, celsius FROM -100 TO 100 WITH 200. Note: if comparing values of v > 100mV use a bigger table (since values for v past the end of the table will use earlier alpha value, etc.)</li>


<li>Make sure the units are set correctly in the ChannelML file.</li>

<li>Be careful to use the temperature, ek, ena of the previous models!</li>

<li>Once you have agreement on NEURON to the original mod, create another Simulation Configuration with only the ChannelML based cell (and the plots, etc.) and try running it on GENESIS.</li>

<li>If you've gotten this far, congratulations. If you have specific problems or think something is outside the scope of the NeuroML specifications, please <a  href="contact.html" >get in touch</a></li>
</ol>

</section>
<p>&nbsp;</p>
<p>&nbsp;</p>

</body>
</document>
